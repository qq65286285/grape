# Grape 后端启动说明

## 问题诊断

如果遇到"页面打开提示连接失败，后端没有日志生成"的问题，通常是以下原因之一：

### 1. 后端依赖的外部服务未启动

后端依赖以下服务：
- **MySQL 数据库** (必需)
- **Redis** (可选，用于缓存)
- **Neo4j** (可选，用于图数据库)
- **Minio** (可选，用于对象存储)

如果这些服务不可用，后端可能无法启动。

### 2. 两种启动方式

#### 方式一：完整模式（需要所有服务）

**前提条件**：
- MySQL 运行在 `192.168.22.140:3306`
- Redis 运行在 `192.168.22.140:6379`
- Neo4j 运行在 `192.168.22.140:7687`
- Minio 运行在 `192.168.22.140:9000`

**启动命令**：
```bash
cd E:\huanle-project\grape-server\grape
mvn spring-boot:run
```

#### 方式二：本地开发模式（只需要 MySQL）

**前提条件**：
- MySQL 运行在 `localhost:3306`（或修改 application-local.yml 中的地址）

**启动命令**：
```bash
cd E:\huanle-project\grape-server\grape
mvn spring-boot:run -Dspring-boot.run.profiles=local
```

或者在 application.yml 中修改：
```yaml
spring:
  profiles:
    active: local  # 改为 local
```

### 3. 检查后端是否启动成功

#### 查看控制台日志
启动后应该看到类似的日志：
```
=== 请求开始 ===
请求URL: GET /api/captcha/gen
客户端IP: 127.0.0.1
...
```

#### 访问健康检查端点
在浏览器访问: `http://localhost:8209/api/`

如果看到 404 或其他错误页面，说明后端已启动。
如果无法连接，说明后端没有启动成功。

### 4. 常见启动失败原因

#### 4.1 MySQL 连接失败
**错误信息**：
```
Communications link failure
```

**解决方案**：
- 确认 MySQL 服务已启动
- 检查数据库地址、端口、用户名、密码
- 确认数据库 `grape` 已创建

#### 4.2 Redis 连接失败
**错误信息**：
```
Unable to connect to Redis
```

**解决方案**：
- 使用本地开发模式（禁用 Redis）
- 或者在 application.yml 中添加：
  ```yaml
  spring:
    autoconfigure:
      exclude:
        - org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration
  ```

#### 4.3 Neo4j 连接失败
**错误信息**：
```
Unable to connect to Neo4j
```

**解决方案**：
- 在 application.yml 中添加：
  ```yaml
  spring:
    autoconfigure:
      exclude:
        - org.springframework.boot.autoconfigure.data.neo4j.Neo4jDataAutoConfiguration
  ```

#### 4.4 端口已被占用
**错误信息**：
```
Port 8209 was already in use
```

**解决方案**：
- 修改 application.yml 中的端口号
- 或者关闭占用 8209 端口的程序

### 5. 查看详细日志

现在后端已经添加了完整的日志系统：

**全局异常日志** - 记录所有异常：
```
2026-01-31 ERROR GlobalExceptionHandler - SQL异常: SQLState=xxx, ErrorCode=xxx, Message=xxx
```

**请求日志** - 记录每个请求：
```
=== 请求开始 ===
请求URL: POST /api/auth/login
客户端IP: 127.0.0.1
User-Agent: Mozilla/5.0...
请求头: content-type=application/json; ...
=== 请求结束 ===
响应状态: 200
处理时长: 125ms
================
```

### 6. 前端配置

确保前端配置正确：

**测试环境** (.env.test)：
```
VUE_APP_API_BASE_URL=http://localhost:8209/api
```

**生产环境** (.env.prod)：
```
VUE_APP_API_BASE_URL=http://192.168.22.140:8209/api
```

### 7. 快速诊断清单

- [ ] MySQL 数据库已启动且可连接
- [ ] 后端应用已启动（控制台有日志输出）
- [ ] 访问 `http://localhost:8209/api/` 有响应
- [ ] 前端 baseURL 配置为 `http://localhost:8209/api`
- [ ] 浏览器控制台没有 CORS 错误
- [ ] 后端日志中有请求记录

### 8. 推荐：先用本地模式测试

如果不确定哪些服务需要，建议：

1. 只启动 MySQL
2. 使用本地开发模式启动后端
3. 查看后端日志，确认启动成功
4. 启动前端并测试
5. 根据实际需要的功能，再逐步启用其他服务

## 需要帮助？

如果仍然无法启动，请提供：
1. 后端启动时的完整控制台日志
2. 前端浏览器控制台的错误信息
3. 哪些外部服务（MySQL/Redis/Neo4j/Minio）已启动
